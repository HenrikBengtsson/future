<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A Future for R: Common Issues with Solutions • future</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="A Future for R: Common Issues with Solutions">
<meta property="og:description" content="future">
<meta property="og:image" content="https://future.futureverse.org/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-SB3EQSD9FR"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SB3EQSD9FR');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">future</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.26.1-9102</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/future-1-overview.html">A Future for R: A Comprehensive Overview</a>
    </li>
    <li>
      <a href="../articles/future-2-output.html">A Future for R: Text and Message Output</a>
    </li>
    <li>
      <a href="../articles/future-3-topologies.html">A Future for R: Future Topologies</a>
    </li>
    <li>
      <a href="../articles/future-4-issues.html">A Future for R: Common Issues with Solutions</a>
    </li>
    <li>
      <a href="../articles/future-4-non-exportable-objects.html">A Future for R: Non-Exportable Objects</a>
    </li>
    <li>
      <a href="../articles/future-5-startup.html">A Future for R: Controlling Default Future Strategy</a>
    </li>
    <li>
      <a href="../articles/future-6-future-api-backend-specification.html">A Future for R: Future API Backend Specification</a>
    </li>
    <li>
      <a href="../articles/future-7-for-package-developers.html">A Future for R: Best Practices for Package Developers</a>
    </li>
    <li>
      <a href="../articles/future-8-how-future-is-validated.html">A Future for R: How the Future Framework is Validated</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://www.futureverse.org/" class="external-link">
    <span class="fas fa-fast-backward"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://BiocParallel.FutureParam.futureverse.org" class="external-link">BiocParallel.FutureParam</a>
    </li>
    <li>
      <a href="https://doFuture.futureverse.org" class="external-link">doFuture</a>
    </li>
    <li>
      <a href="https://furrr.futureverse.org" class="external-link">furrr</a>
    </li>
    <li>
      <a href="https://future.futureverse.org">future</a>
    </li>
    <li>
      <a href="https://future.apply.futureverse.org" class="external-link">future.apply</a>
    </li>
    <li>
      <a href="https://future.batchtools.futureverse.org" class="external-link">future.batchtools</a>
    </li>
    <li>
      <a href="https://future.callr.futureverse.org" class="external-link">future.callr</a>
    </li>
    <li>
      <a href="https://future.tests.futureverse.org" class="external-link">future.tests</a>
    </li>
    <li>
      <a href="https://globals.futureverse.org" class="external-link">globals</a>
    </li>
    <li>
      <a href="https://listenv.futureverse.org" class="external-link">listenv</a>
    </li>
    <li>
      <a href="https://parallelly.futureverse.org" class="external-link">parallelly</a>
    </li>
    <li>
      <a href="https://progressr.futureverse.org" class="external-link">progressr</a>
    </li>
    <li>
      <a href="https://future.mapreduce.futureverse.org" class="external-link">future.mapreduce (experimental)</a>
    </li>
    <li>
      <a href="https://marshal.futureverse.org" class="external-link">marshal (experimental)</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://cloud.r-project.org/package=future" class="external-link">
    <span class="fab fa-r-project"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/HenrikBengtsson/future/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>A Future for R: Common Issues with
Solutions</h1>
                        <h4 data-toc-skip class="author">Henrik
Bengtsson</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/HenrikBengtsson/future/blob/HEAD/vignettes/future-4-issues.md.rsp" class="external-link"><code>vignettes/future-4-issues.md.rsp</code></a></small>
      <div class="hidden name"><code>future-4-issues.md.rsp</code></div>

    </div>

    
    
<p>In the ideal case, all it takes to start using futures in R is to
replace select standard assignments (<code>&lt;-</code>) in your R code
with future assignments (<code>%&lt;-%</code>) and make sure the
right-hand side (RHS) expressions are within curly brackets
(<code>{ ... }</code>). Also, if you assign these to lists (e.g. in a
for loop), you need to use a list environment (<code>listenv</code>)
instead of a plain list.</p>
<p>However, as show below, there are few cases where you might run into
some hurdles, but, as also shown, they are often easy to overcome. These
are often related to global variables.</p>
<p><em>If you identify other cases, please consider <a href="https://github.com/HenrikBengtsson/future/issues/" class="external-link">reporting</a>
them so they can be documented here and possibly even be fixed.</em></p>
<div class="section level2">
<h2 id="issues-with-globals-and-packages">Issues with globals and packages<a class="anchor" aria-label="anchor" href="#issues-with-globals-and-packages"></a>
</h2>
<div class="section level3">
<h3 id="missing-globals-false-negatives">Missing globals (false negatives)<a class="anchor" aria-label="anchor" href="#missing-globals-false-negatives"></a>
</h3>
<p>If a global variable is used in a future expression that
<em>conditionally</em> overrides this global variable with a local one,
the future framework fails to identify the global variable and therefore
fails to export it, resulting in a run-time error. For example, although
this works:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>

<span class="va">reset</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">y</span> <span class="op"><a href="../reference/future.html">%&lt;-%</a></span> <span class="op">{</span> <span class="kw">if</span> <span class="op">(</span><span class="va">reset</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">0</span>; <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">}</span>
<span class="va">y</span>
<span class="co">## [1] 1</span></code></pre></div>
<p>the following does <em>not</em> work:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">reset</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">y</span> <span class="op"><a href="../reference/future.html">%&lt;-%</a></span> <span class="op">{</span> <span class="kw">if</span> <span class="op">(</span><span class="va">reset</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">0</span>; <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">}</span>
<span class="va">y</span>
<span class="co">## Error: object 'x' not found</span></code></pre></div>
<p>It is recommended to avoid above constructs where it is ambiguous
whether a variable is global or local. To force variable <code>x</code>
to always be global, insert it at the very being of the future
expression, e.g.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">reset</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">y</span> <span class="op"><a href="../reference/future.html">%&lt;-%</a></span> <span class="op">{</span> <span class="va">x</span>; <span class="kw">if</span> <span class="op">(</span><span class="va">reset</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">0</span>; <span class="va">x</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">}</span>
<span class="va">y</span>
<span class="co">## [1] 2</span></code></pre></div>
<p><em>Comment:</em> The goal is to in a future version of the package
detect globals also in expression where the local-global state of a
variable is only known at run time.</p>
<div class="section level4">
<h4 id="do-call---function-not-found">do.call() - function not found<a class="anchor" aria-label="anchor" href="#do-call---function-not-found"></a>
</h4>
<p>When calling a function using <code><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call()</a></code> make sure to
specify the function as the object itself and not by name. This will
help identify the function as a global object in the future expression.
For instance, use</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">file_ext</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"foo.txt"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>instead of</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"file_ext"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"foo.txt"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>so that <code>file_ext()</code> is properly located and exported.
Although you may not notice a difference when evaluating futures in the
same R session, it may become a problem if you use a character string
instead of a function object when futures are evaluated in external R
sessions, such as on a cluster. It may also become a problem with
futures evaluated with lazy evaluation if the intended function is
redefined after the future is resolved. For example,</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(future)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(listenv)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(tools)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plan</span>(sequential)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> pathnames <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"foo.txt"</span>, <span class="st">"bar.png"</span>, <span class="st">"yoo.md"</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> res <span class="ot">&lt;-</span> <span class="fu">listenv</span>()</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="cf">for</span> (ii <span class="cf">in</span> <span class="fu">seq_along</span>(pathnames)) {</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="sc">+</span>   res[[ii]] <span class="sc">%&lt;-%</span> <span class="fu">do.call</span>(<span class="st">"file_ext"</span>, <span class="fu">list</span>(pathnames[ii])) <span class="sc">%lazy%</span> <span class="cn">TRUE</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="sc">+</span> }</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> file_ext <span class="ot">&lt;-</span> <span class="cf">function</span>(...) <span class="st">"haha!"</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">unlist</span>(res)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"haha!"</span> <span class="st">"haha!"</span> <span class="st">"haha!"</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="get---object-not-found">get() - object not found<a class="anchor" aria-label="anchor" href="#get---object-not-found"></a>
</h4>
<p>The base R function <code><a href="https://rdrr.io/r/base/get.html" class="external-link">get()</a></code> can be used to get the value
of a object by its name. For example,
<code>get("pi", envir = baseenv())</code> will get the value of object
<code>pi</code> in the ‘base’ environment, i.e. it corresponds to
<code><a href="https://rdrr.io/r/base/Constants.html" class="external-link">base::pi</a></code>. If no other objects named <code>pi</code> exists
on the search path, we could have used <code>get("pi")</code> and
<code>pi</code>, respectively. It is not unusual to see code snippets
such as:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> a <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> b <span class="ot">&lt;-</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">6</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> c <span class="ot">&lt;-</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">5</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> my_sum <span class="ot">&lt;-</span> <span class="cf">function</span>(var) { <span class="fu">sum</span>(<span class="fu">get</span>(var)) }</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y <span class="ot">&lt;-</span> <span class="fu">my_sum</span>(<span class="st">"a"</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">6</span></span></code></pre></div>
<p>If we attempt to call <code>my_sum()</code> via a future, we will get
an error (if the future is resolved in an external R process);</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(future)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plan</span>(multisession)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> f <span class="ot">&lt;-</span> <span class="fu">future</span>(<span class="fu">my_sum</span>(<span class="st">"a"</span>))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y <span class="ot">&lt;-</span> <span class="fu">value</span>(f)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>Error <span class="cf">in</span> <span class="fu">get</span>(var) <span class="sc">:</span> object <span class="st">'a'</span> not found</span></code></pre></div>
<p>This is because the static code inspection done on the future
expression <code>my_sum("a")</code> does not reveal object
<code>a</code> as a global object. In that expression alone, there are
only three objects: the function <code>my_sum()</code>, the primitive
function <code>(</code>, and the string <code>"a"</code>, and none of
those are object <code>a</code>. The future framework will also scan
these three objects for globals, which in this example means that it
scans also <code>my_sum()</code>. This recursive search for globals will
identify three additional globals, namely, the primitive function
<code>{</code>, the function <code><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum()</a></code>, and the function
<code><a href="https://rdrr.io/r/base/get.html" class="external-link">get()</a></code>, but, as before, none of these source will identify
<code>a</code> as a global object. In order for <code>a</code> to be
identified, the future framework would need to have a built-in
understanding on how <code>get(var)</code> works, which would be a
daunting task, especially if it need to know it acts for different data
types of <code>var</code> and various choices on arguments
<code>envir</code> and <code>enclos</code>. In fact, this can often not
be inferred until run time, that is, it is not possible to identify what
objects are needed without actually running the code. In short, it is
not possible to automatically identify global variables specified via a
character string.</p>
<p>The workaround is to tell the future framework what
<em>additional</em> globals are needed. This can be done via argument
<code>globals</code> using:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> f <span class="ot">&lt;-</span> <span class="fu">future</span>(<span class="fu">my_sum</span>(<span class="st">"a"</span>), <span class="at">globals =</span> <span class="fu">structure</span>(<span class="cn">TRUE</span>, <span class="at">add =</span> <span class="st">"a"</span>))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y <span class="ot">&lt;-</span> <span class="fu">value</span>(f)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">6</span></span></code></pre></div>
<p>or ny injecting variable <code>a</code> at the beginning of the
future expression, e.g.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> f <span class="ot">&lt;-</span> <span class="fu">future</span>({ a; <span class="fu">my_sum</span>(<span class="st">"a"</span>) })</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y <span class="ot">&lt;-</span> <span class="fu">value</span>(f)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">6</span></span></code></pre></div>
<p>Note that, independently of the future framework, it is often a bad
idea to use <code><a href="https://rdrr.io/r/base/get.html" class="external-link">get()</a></code>, and related functions
<code><a href="https://rdrr.io/r/base/get.html" class="external-link">mget()</a></code> and <code><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign()</a></code>, in R code. Searching the
archives of R forums, such as the R-help and R-devel mailing lists, will
reveal numerous suggestions against using them. A good rule of thumb
is:</p>
<blockquote>
<p>If you find yourself using <code><a href="https://rdrr.io/r/base/get.html" class="external-link">get()</a></code> in your code, take a
step back, and reconsider your implementation. There is most likely a
better solution available.</p>
</blockquote>
<p>For example, consider this, slightly more complex, example:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> a <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> b <span class="ot">&lt;-</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">7</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> c <span class="ot">&lt;-</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">5</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> my_sum <span class="ot">&lt;-</span> <span class="cf">function</span>(var) { <span class="fu">sum</span>(<span class="fu">get</span>(var)) }</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="fu">c</span>(<span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span>), <span class="at">FUN =</span> my_sum)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a> a  b  c</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a> <span class="dv">6</span> <span class="dv">22</span> <span class="dv">12</span></span></code></pre></div>
<p>Instead of using “free roaming” objects <code>a</code>,
<code>b</code>, and <code>c</code>, it’s better to put those values in a
list (or a data frame of of the same length);</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">a =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">b =</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">7</span>, <span class="at">c =</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">5</span>)</span></code></pre></div>
<p>This will in turn allow us to perform the same calculations without
having to use <code><a href="https://rdrr.io/r/base/get.html" class="external-link">get()</a></code>;</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> my_sum <span class="ot">&lt;-</span> <span class="cf">function</span>(x) { <span class="fu">sum</span>(x) }</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y <span class="ot">&lt;-</span> <span class="fu">sapply</span>(data, <span class="at">FUN =</span> my_sum)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a> a  b  c</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a> <span class="dv">6</span> <span class="dv">22</span> <span class="dv">12</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="glueglue---object-not-found">glue::glue() - object not found<a class="anchor" aria-label="anchor" href="#glueglue---object-not-found"></a>
</h4>
<p>The future framework will fail to identify globals that are declared
via character strings. The above section gives an example of this where
<code><a href="https://rdrr.io/r/base/get.html" class="external-link">get()</a></code> is used and explains why it is not feasible to
automatically identify string-embedded globals from such code. Another
example, is when using <code>glue()</code> from the glue package to
generate strings dynamically, e.g.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(glue)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> a <span class="ot">&lt;-</span> <span class="dv">42</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> s <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"The value of a is {a}."</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> s</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>The value of a is <span class="fl">42.</span></span></code></pre></div>
<p>Attempt to perform the same via a future that is resolved in another
R session will produce an “object not found” error;</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(glue)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(future)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plan</span>(multisession)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> a <span class="ot">&lt;-</span> <span class="dv">42</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> s <span class="sc">%&lt;-%</span> <span class="fu">glue</span>(<span class="st">"The value of a is {a}."</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> s</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>Error <span class="cf">in</span> <span class="fu">eval</span>(<span class="fu">parse</span>(<span class="at">text =</span> text, <span class="at">keep.source =</span> <span class="cn">FALSE</span>), envir) <span class="sc">:</span> </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  object <span class="st">'a'</span> not found</span></code></pre></div>
<p>As explained in the previous section, the workaround is to specify
what additional global variables there are, which can be done as:</p>
<pre><code>&gt; s %&lt;-% glue("The value of a is {a}.") %globals% structure(TRUE, add = "a")
&gt; s
The value of a is 42.</code></pre>
<p>An alternative solution is to guide the future framework by adding
the missing globals as “dummy” variables, e.g.</p>
<pre><code>&gt; s %&lt;-% { a; glue("The value of a is {a}.") }
&gt; s
The value of a is 42.</code></pre>
</div>
</div>
<div class="section level3">
<h3 id="missing-packages-false-negatives">Missing packages (false negatives)<a class="anchor" aria-label="anchor" href="#missing-packages-false-negatives"></a>
</h3>
<p>Occasionally, the static-code inspection of the future expression
fails to identify packages needed to evaluated the expression. This may
occur when an expression uses S3 generic functions part of one package
whereas the required S3 method is in another package. For example, in
the below future generic function <code>[</code> is used on data.table
object <code>DT</code>, which requires S3 method
<code>[.data.table</code> from the data.table package. However, the
future and global packages fail to identify data.table as a required
package, which results in an evaluation error:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(future)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plan</span>(multisession)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(data.table)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> DT <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">a =</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>], <span class="at">b =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y <span class="sc">%&lt;-%</span> DT[, <span class="fu">sum</span>(b)]</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>Error<span class="sc">:</span> object <span class="st">'b'</span> not found</span></code></pre></div>
<p>The above error occurs because, contrary to the master R process, the
R worker that evaluated the future expression does not have data.table
loaded. Instead the evaluation falls back to the
<code>[.data.frame</code> method, which is not what we want.</p>
<p>Until the future framework manages to identify data.table as a
required package (which is the goal), we can guide future by specifying
additional packages needed:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y <span class="sc">%&lt;-%</span> DT[, <span class="fu">sum</span>(b)] <span class="sc">%packages%</span> <span class="st">"data.table"</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">6</span></span></code></pre></div>
<p>or equivalently</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> f <span class="ot">&lt;-</span> <span class="fu">future</span>(DT[, <span class="fu">sum</span>(b)], <span class="at">packages =</span> <span class="st">"data.table"</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">value</span>(f)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">6</span></span></code></pre></div>
<p>Note, do <em>not</em> use <code><a href="https://rdrr.io/r/base/library.html" class="external-link">library()</a></code> or
<code><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">loadNamespace()</a></code> to resolve these problems. It is always
better to use the above <code>packages</code> approach.</p>
</div>
</div>
<div class="section level2">
<h2 id="non-exportable-objects">Non-exportable objects<a class="anchor" aria-label="anchor" href="#non-exportable-objects"></a>
</h2>
<p>Certain types of objects are tied to a given R session and cannot be
passed along to another R process (a “worker”). An example of a
non-exportable object is is XML objects of the xml2 package. If we
attempt to use those in parallel processing, we may get a error when the
future is evaluated (or just invalid results depending on how they are
used), e.g.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(future)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plan</span>(multisession)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(xml2)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> xml <span class="ot">&lt;-</span> <span class="fu">read_xml</span>(<span class="st">"&lt;body&gt;&lt;/body&gt;"</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> f <span class="ot">&lt;-</span> <span class="fu">future</span>(<span class="fu">xml_children</span>(xml))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">value</span>(f)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>Error<span class="sc">:</span> external pointer is not valid</span></code></pre></div>
<p>The future framework can help detect this <em>before</em> sending off
the future to the worker;</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">options</span>(<span class="at">future.globals.onReference =</span> <span class="st">"error"</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> f <span class="ot">&lt;-</span> <span class="fu">future</span>(<span class="fu">xml_children</span>(xml))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>Error <span class="cf">in</span> <span class="cn">FALSE</span> <span class="sc">:</span> </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  Detected a non<span class="sc">-</span>exportable <span class="fu">reference</span> (<span class="st">'externalptr'</span>) <span class="cf">in</span> one of the globals</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>(<span class="st">'xml'</span> of class <span class="st">'xml_document'</span>) used <span class="cf">in</span> the future expression</span></code></pre></div>
<p>For additional details on non-exportable objects and examples of
other R packages that use objects that may cause problems in parallel
processing, see Vignette ‘Non-Exportable Objects’.</p>
</div>
<div class="section level2">
<h2 id="trying-to-pass-an-unresolved-future-to-another-future">Trying to pass an unresolved future to another future<a class="anchor" aria-label="anchor" href="#trying-to-pass-an-unresolved-future-to-another-future"></a>
</h2>
<p>It is not possible for a future to resolve another one unless it was
created by the future trying to resolve it. For instance, the following
gives an error:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(future)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">plan</span>(multisession)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> f1 <span class="ot">&lt;-</span> <span class="fu">future</span>({ <span class="fu">Sys.getpid</span>() })</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> f2 <span class="ot">&lt;-</span> <span class="fu">future</span>({ <span class="fu">value</span>(f1) })</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> v1 <span class="ot">&lt;-</span> <span class="fu">value</span>(f1)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">7464</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> v2 <span class="ot">&lt;-</span> <span class="fu">value</span>(f2)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>Error<span class="sc">:</span> Invalid usage of futures<span class="sc">:</span> A future whose value has not yet been collected</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a> can only be queried by the R <span class="fu">process</span> (cdd013cb<span class="sc">-</span>e045<span class="sc">-</span>f4a5<span class="dv">-3977</span><span class="sc">-</span>9f064c31f188; pid</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a> <span class="dv">1276</span> on MyMachine) that created it, not by any other R <span class="fu">processes</span> (5579f789<span class="sc">-</span>e7b6</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a> <span class="sc">-</span>bace<span class="sc">-</span>c50d<span class="sc">-</span>6c7a23ddb5a3; pid <span class="dv">2352</span> on MyMachine)<span class="sc">:</span> {; <span class="fu">Sys.getpid</span>(); }</span></code></pre></div>
<p>This is because the main R process creates two futures, but then the
second future tries to retrieve the value of the first one. This is an
invalid request because the second future has no channel to communicate
with the first future; it is only the process that created a future who
can communicate with it(*).</p>
<p>Note that it is only <em>unresolved</em> futures that cannot be
queried this way. Thus, the solution to the above problem is to make
sure all futures are resolved before they are passed to other futures,
e.g.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> f1 <span class="ot">&lt;-</span> <span class="fu">future</span>({ <span class="fu">Sys.getpid</span>() })</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> v1 <span class="ot">&lt;-</span> <span class="fu">value</span>(f1)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> v1</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">7464</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> f2 <span class="ot">&lt;-</span> <span class="fu">future</span>({ <span class="fu">value</span>(f1) })</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> v2 <span class="ot">&lt;-</span> <span class="fu">value</span>(f2)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> v2</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">7464</span></span></code></pre></div>
<p>This works because the value has already been collected and stored
inside future <code>f1</code> before future <code>f2</code> is created.
Since the value is already stored internally, <code>value(f1)</code> is
readily available everywhere. Of course, instead of using
<code>value(f1)</code> for the second future, it would be more readable
and cleaner to simply use <code>v1</code>.</p>
<p>The above is typically not a problem when future assignments are
used. For example:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> v1 <span class="sc">%&lt;-%</span> { <span class="fu">Sys.getpid</span>() }<span class="er">)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> v2 <span class="sc">%&lt;-%</span> { v1 }</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> v1</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">2352</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> v2</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">2352</span></span></code></pre></div>
<p>The reason that this approach works out of the box is because in the
second future assignment <code>v1</code> is identified as a global
variable, which is retrieved. Up to this point, <code>v1</code> is a
promise (“delayed assignment” in R), but when it is retrieved as a
global variable its value is resolved and <code>v1</code> becomes a
regular variable.</p>
<p>However, there are cases where future assignments can be passed via
global variables without being resolved. This can happen if the future
assignment is done to an element of an environment (including list
environments). For instance,</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(listenv)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> x <span class="ot">&lt;-</span> <span class="fu">listenv</span>()</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> x<span class="sc">$</span>a <span class="sc">%&lt;-%</span> { <span class="fu">Sys.getpid</span>() }</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> x<span class="sc">$</span>b <span class="sc">%&lt;-%</span> { x<span class="sc">$</span>a }</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> x<span class="sc">$</span>a</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">2352</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> x<span class="sc">$</span>b</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>Error<span class="sc">:</span> Invalid usage of futures<span class="sc">:</span> A future whose value has not yet been collected</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a> can only be queried by the R <span class="fu">process</span> (cdd013cb<span class="sc">-</span>e045<span class="sc">-</span>f4a5<span class="dv">-3977</span><span class="sc">-</span>9f064c31f188; pid</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a> <span class="dv">1276</span> on localhost) that created it, not by any other R <span class="fu">processes</span> (2ce86ccd<span class="dv">-5854</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a> <span class="sc">-</span>7a05<span class="dv">-1373</span><span class="sc">-</span>e1b20022e4d8; pid <span class="dv">7464</span> on localhost)<span class="sc">:</span> {; <span class="fu">Sys.getpid</span>(); }</span></code></pre></div>
<p>As previously, this can be avoided by making sure <code>x$a</code> is
resolved first, which can be one in various ways,
e.g. <code>dummy &lt;- x$a</code>, <code>resolve(x$a)</code> and
<code>force(x$a)</code>.</p>
<p><em>Footnote</em>: (*) Although sequential futures could be passed on
to other futures part of the same R process and be resolved there
because they share the same evaluation process, by definition of the
Future API it is invalid to do so regardless of future type. This
conservative approach is taken in order to make future expressions
behave consistently regardless of the type of future used.</p>
</div>
<div class="section level2">
<h2 id="miscellaneous">Miscellaneous<a class="anchor" aria-label="anchor" href="#miscellaneous"></a>
</h2>
<div class="section level3">
<h3 id="capturing-errors-outputting-their-messages-and-returning-a-default-value">Capturing errors, outputting their messages, and returning a default
value<a class="anchor" aria-label="anchor" href="#capturing-errors-outputting-their-messages-and-returning-a-default-value"></a>
</h3>
<p>Sometimes a function call produce an error for a particular input. In
such cases, we might want to return a default value, say, a missing
value, instead of signaling an error. This can be done using:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span>
  <span class="fu">unstable_calc</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span>
  <span class="cn">NA_real_</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>Here, <code>res</code> takes the value of
<code>unstable_calc(x)</code>, unless it produces an error, in case it
takes value <code>NA_real_</code>.</p>
<p>In addition to the above, we could produce a warning whenever we get
an error and replace it with a missing value. We can do this as:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="op">{</span>
  <span class="fu">unstable_calc</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">conditionMessage</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span><span class="op">)</span>
  <span class="cn">NA_real_</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>This will turn the error into a warning with the same message. If we
want to just output the message without producing a warning, we can use
<code>message(conditionMessage(e))</code>.</p>
<p>Importantly, we must not use just <code>warning(e)</code> or
<code>message(e)</code>, although it appears to work at a first glance.
If we do, we will end up re-signaling the error but without
interruption. It is an important distinction that will reveal itself if
used within futures. The above example with
<code>warning(conditionMessage(e))</code> will work as expected, but if
we use <code>warning(e)</code> the future framework will produce an
error, not a warning.</p>
</div>
<div class="section level3">
<h3 id="clashes-with-other-packages">Clashes with other packages<a class="anchor" aria-label="anchor" href="#clashes-with-other-packages"></a>
</h3>
<p>Sometimes other packages have functions or operators with the same
name as the future package, and if those packages are attached
<em>after</em> the future package, their objects will mask the ones of
the future package. For instance, the igraph package also defines a
<code>%&lt;-%</code> operator which clashes with the one in future
<em>if used at the prompt or in a script</em> (it is not a problem
inside package because there we explicitly import objects in a known
order). Here is what we might get:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(future)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(igraph)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>Attaching package<span class="sc">:</span> <span class="st">'igraph'</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>The following objects are masked from <span class="st">'package:future'</span><span class="sc">:</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="sc">%&lt;-%</span>, <span class="sc">%-&gt;%</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>The following objects are masked from <span class="st">'package:stats'</span><span class="sc">:</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    decompose, spectrum</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>The following object is masked from <span class="st">'package:base'</span><span class="sc">:</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    union</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y <span class="sc">%&lt;-%</span> { <span class="dv">42</span> }</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>Error <span class="cf">in</span> <span class="fu">get</span>(<span class="st">".igraph.from"</span>, <span class="fu">parent.frame</span>()) <span class="sc">:</span> </span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>  object <span class="st">'.igraph.from'</span> not found</span></code></pre></div>
<p>Here we get an error because <code>%&lt;-%</code> is from igraph and
not the future assignment operator as we wanted. This can be confirmed
as:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">environment</span>(<span class="st">`</span><span class="at">%&lt;-%</span><span class="st">`</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&lt;</span>environment<span class="sc">:</span> namespace<span class="sc">:</span>igraph<span class="sc">&gt;</span></span></code></pre></div>
<p>To avoid this problem, attach the two packages in opposite order such
that future comes last and thereby overrides igraph, i.e.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(igraph)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(future)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>Attaching package<span class="sc">:</span> <span class="st">'future'</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>The following objects are masked from <span class="st">'package:igraph'</span><span class="sc">:</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="sc">%&lt;-%</span>, <span class="sc">%-&gt;%</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="er">&gt;</span> y <span class="sc">%&lt;-%</span> { <span class="dv">42</span> }</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">42</span></span></code></pre></div>
<p>An alternative is to detach the future package and re-attach it,
which will achieve the same thing:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">detach</span>(<span class="st">"package:future"</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">library</span>(future)</span></code></pre></div>
<p>Yet another alternative is to explicitly override the object by
importing it to the global environment, e.g.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="st">`</span><span class="at">%&lt;-%</span><span class="st">`</span> <span class="ot">&lt;-</span> future<span class="sc">::</span><span class="st">`</span><span class="at">%&lt;-%</span><span class="st">`</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y <span class="sc">%&lt;-%</span> { <span class="dv">42</span> }</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> y</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">42</span></span></code></pre></div>
<p>In this case, it does not matter in what order the packages are
attached because we will always use the copy of
<code><a href="../reference/future.html">future::`%&lt;-%`</a></code>.</p>
</div>
<div class="section level3">
<h3 id="syntax-error-non-numeric-argument-to-binary-operator">Syntax error: “non-numeric argument to binary operator”<a class="anchor" aria-label="anchor" href="#syntax-error-non-numeric-argument-to-binary-operator"></a>
</h3>
<p>The future assignment operator <code>%&lt;-%</code> is a <em>binary
infix operator</em>, which means it has higher precedence than most
other binary operators but also higher than some of the unary operators
in R. For instance, this explains why we get the following error:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> x <span class="sc">%&lt;-%</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">runif</span>(<span class="dv">1</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>Error <span class="cf">in</span> x <span class="sc">%&lt;-%</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">:</span> non<span class="sc">-</span>numeric argument to binary operator</span></code></pre></div>
<p>What effectively is happening here is that because of the higher
priority of <code>%&lt;-%</code>, we first create a future
<code>x %&lt;-% 2</code> and then we try to multiply the future (not its
value) with the value of <code>runif(1)</code> - which makes no sense.
In order to properly assign the future variable, we need to put the
future expression within curly brackets;</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> x <span class="sc">%&lt;-%</span> { <span class="dv">2</span> <span class="sc">*</span> <span class="fu">runif</span>(<span class="dv">1</span>) }</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> x</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">1.030209</span></span></code></pre></div>
<p>Parentheses will also do. For details on precedence on operators in
R, see Section ‘Infix and prefix operators’ in the ‘R Language
Definition’ document.</p>
</div>
<div class="section level3">
<h3 id="r-cmd-check-notes">R CMD check NOTEs<a class="anchor" aria-label="anchor" href="#r-cmd-check-notes"></a>
</h3>
<p>The code inspection run by <code>R CMD check</code> will not
recognize the future assignment operator <code>%&lt;-%</code> as an
assignment operator, which is not surprising because
<code>%&lt;-%</code> is technically an infix operator. This means that
if you for instance use the following code in your package:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">foo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">b</span> <span class="op">&lt;-</span> <span class="fl">3.14</span>
  <span class="va">a</span> <span class="op"><a href="../reference/future.html">%&lt;-%</a></span> <span class="op">{</span> <span class="va">b</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">}</span>
  <span class="va">a</span>
<span class="op">}</span></code></pre></div>
<p>then <code>R CMD check</code> will produce a NOTE saying:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="ex">*</span> checking R code for possible problems ... NOTE</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="ex">foo:</span> no visible binding for global variable <span class="st">'a'</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Undefined</span> global functions or variables:</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">a</span></span></code></pre></div>
<p>In order to avoid this, we can add a dummy assignment of the missing
global at the top of the function, i.e.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">foo</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">a</span> <span class="op">&lt;-</span> <span class="cn">NULL</span> <span class="co">## To please R CMD check</span>
  <span class="va">b</span> <span class="op">&lt;-</span> <span class="fl">3.14</span>
  <span class="va">a</span> <span class="op"><a href="../reference/future.html">%&lt;-%</a></span> <span class="op">{</span> <span class="va">b</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">}</span>
  <span class="va">a</span>
<span class="op">}</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Henrik Bengtsson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3</p> and <a href="https://github.com/HenrikBengtsson/pkgdown.extras/">pkgdown.extras</a> 0.0.0.9004.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: 'aa6e02fc501886fb0f7c91ac4e300456',
    indexName: 'futureverse',
    algoliaOptions: { 'facetFilters': ['project:future'] },
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
