<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A Future for R: Non-Exportable Objects â€¢ future</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="A Future for R: Non-Exportable Objects">
<meta property="og:description" content="future">
<meta property="og:image" content="https://future.futureverse.org/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-SB3EQSD9FR"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SB3EQSD9FR');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">future</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.21.0-9002</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/future-1-overview.html">A Future for R: A Comprehensive Overview</a>
    </li>
    <li>
      <a href="../articles/future-2-output.html">A Future for R: Text and Message Output</a>
    </li>
    <li>
      <a href="../articles/future-3-topologies.html">A Future for R: Future Topologies</a>
    </li>
    <li>
      <a href="../articles/future-4-issues.html">A Future for R: Common Issues with Solutions</a>
    </li>
    <li>
      <a href="../articles/future-4-non-exportable-objects.html">A Future for R: Non-Exportable Objects</a>
    </li>
    <li>
      <a href="../articles/future-5-startup.html">A Future for R: Controlling Default Future Strategy</a>
    </li>
    <li>
      <a href="../articles/future-6-future-api-backend-specification.html">A Future for R: Future API Backend Specification</a>
    </li>
    <li>
      <a href="../articles/future-7-for-package-developers.html">A Future for R: Best Practices for Package Developers</a>
    </li>
    <li>
      <a href="../articles/future-8-how-future-is-validated.html">A Future for R: How the Future Framework is Validated</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://www.futureverse.org/">
    <span class="fas fa-fast-backward"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://BiocParallel.FutureParam.futureverse.org">BiocParallel.FutureParam</a>
    </li>
    <li>
      <a href="https://doFuture.futureverse.org">doFuture</a>
    </li>
    <li>
      <a href="https://furrr.futureverse.org">furrr</a>
    </li>
    <li>
      <a href="https://future.futureverse.org">future</a>
    </li>
    <li>
      <a href="https://future.apply.futureverse.org">future.apply</a>
    </li>
    <li>
      <a href="https://future.batchtools.futureverse.org">future.batchtools</a>
    </li>
    <li>
      <a href="https://future.callr.futureverse.org">future.callr</a>
    </li>
    <li>
      <a href="https://future.tests.futureverse.org">future.tests</a>
    </li>
    <li>
      <a href="https://globals.futureverse.org">globals</a>
    </li>
    <li>
      <a href="https://listenv.futureverse.org">listenv</a>
    </li>
    <li>
      <a href="https://parallelly.futureverse.org">parallelly</a>
    </li>
    <li>
      <a href="https://progressr.futureverse.org">progressr</a>
    </li>
    <li>
      <a href="https://future.mapreduce.futureverse.org">future.mapreduce (experimental)</a>
    </li>
    <li>
      <a href="https://marshal.futureverse.org">marshal (experimental)</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://cloud.r-project.org/package=future">
    <span class="fab fa-r-project"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/HenrikBengtsson/future/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>A Future for R: Non-Exportable Objects</h1>
                        <h4 class="author">Henrik Bengtsson</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/HenrikBengtsson/future/blob/master/vignettes/future-4-non-exportable-objects.md.rsp"><code>vignettes/future-4-non-exportable-objects.md.rsp</code></a></small>
      <div class="hidden name"><code>future-4-non-exportable-objects.md.rsp</code></div>

    </div>

    
    
<p>Certain types of objects are tied to a given R session. Such objects cannot be saved to file by one R process and then later be reloaded in another R process and expected to work correctly. If attempted, we will often get an informative error but not always. For the same reason, these type of objects cannot be exported to another R processes(*) for parallel processing regardless of which parallelization framework we use. We refer to these type of objects as "non-exportable objects".</p>
<p>(*) The exception <em>might be</em> when <em>forked</em> processes are used, i.e. <code><a href="../reference/plan.html">plan(multicore)</a></code>. However, such attempts to work around the underlying problem, which is non-exportable objects, should be avoided and considered non-stable. Moreover, such code will fail to parallelize when using other future backends.</p>
<div id="a-first-example---file-connections" class="section level2">
<h2 class="hasAnchor">
<a href="#a-first-example---file-connections" class="anchor"></a>A first example - file connections</h2>
<p>An example of a non-exportable object is a connection, e.g. a file connection. For instance, if you create a file connection,</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/connections.html">file</a></span><span class="op">(</span><span class="st">"output.log"</span>, open <span class="op">=</span> <span class="st">"wb"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"hello "</span>, file <span class="op">=</span> <span class="va">con</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/connections.html">flush</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span><span class="op">(</span><span class="st">"output.log"</span>, warn <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">## [1] "hello "</span></code></pre></div>
<p>it will not work when used in another R process. If we try, the result is "unknown", e.g.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>
<span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/future.html">future</a></span><span class="op">(</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"world!"</span>, file <span class="op">=</span> <span class="va">con</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/connections.html">flush</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span>
<span class="fu"><a href="../reference/value.html">value</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span>
<span class="co">## NULL</span>
<span class="fu"><a href="https://rdrr.io/r/base/connections.html">close</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readLines.html">readLines</a></span><span class="op">(</span><span class="st">"output.log"</span>, warn <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co">## [1] "hello "</span></code></pre></div>
<p>In other words, the output <code>"world!"</code> written by the R worker is completely lost.</p>
<p>The culprit here is that the connection uses a so called <em>external pointer</em>:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span>
<span class="co">## Classes 'file', 'connection'  atomic [1:1] 3</span>
<span class="co">##   ..- attr(*, "conn_id")=&lt;externalptr&gt; </span></code></pre></div>
<p>which is bound to the main R process and makes no sense to the worker. Ideally, the R process of the worker would detect this and produce an informative error message, but as seen here, that does not always occur.</p>
</div>
<div id="protect-against-non-exportable-objects" class="section level2">
<h2 class="hasAnchor">
<a href="#protect-against-non-exportable-objects" class="anchor"></a>Protect against non-exportable objects</h2>
<p>To help avoiding exporting non-exportable objects by mistakes, which typically happens because a global variable is non-exportable, the future framework provides a mechanism for automatically detecting such objects. To enable it, do:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>future.globals.onReference <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span>
<span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/future.html">future</a></span><span class="op">(</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"world!"</span>, file <span class="op">=</span> <span class="va">con</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/connections.html">flush</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span>
<span class="co">## Error: Detected a non-exportable reference ('externalptr') in one of the globals</span>
<span class="co">## ('con' of class 'file') used in the future expression</span></code></pre></div>
<p><em>Comment</em>: The <code>future.globals.onReference</code> options is set to <code>"ignore"</code> by default due to the extra overhead <code>"error"</code> introduces, which can be significant for very large nested objects. Furthermore, some subclasses of external pointers can be exported without causing problems.</p>
</div>
<div id="packages-with-non-exportable-objects" class="section level2">
<h2 class="hasAnchor">
<a href="#packages-with-non-exportable-objects" class="anchor"></a>Packages with non-exportable objects</h2>
<p>The below table and sections provide a few examples of non-exportable R objects that you may run into when trying to parallelize your code, or simply from trying reload objects saved in a previous R session. <em>If you identify other cases, please consider <a href="https://github.com/HenrikBengtsson/future/issues/">reporting</a> them so they can be documented here and possibly even be fixed.</em></p>
<table class="table">
<colgroup>
<col width="23%">
<col width="62%">
</colgroup>
<thead><tr class="header">
<th align="left">Package</th>
<th align="left">Examples of non-exportable types or classes</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left"><strong>base</strong></td>
<td align="left">connection (<code>externalptr</code>)</td>
</tr>
<tr class="even">
<td align="left"><strong>DBI</strong></td>
<td align="left">DBIConnection (<code>externalptr</code>)</td>
</tr>
<tr class="odd">
<td align="left"><strong>keras</strong></td>
<td align="left">keras.engine.sequential.Sequential (<code>externalptr</code>)</td>
</tr>
<tr class="even">
<td align="left"><strong>magick</strong></td>
<td align="left">magick-image (<code>externalptr</code>)</td>
</tr>
<tr class="odd">
<td align="left"><strong>ncdf4</strong></td>
<td align="left">ncdf4 (custom reference; <em>non-detectable</em>)</td>
</tr>
<tr class="even">
<td align="left"><strong>parallel</strong></td>
<td align="left">cluster and cluster nodes (<code>connection</code>)</td>
</tr>
<tr class="odd">
<td align="left"><strong>raster</strong></td>
<td align="left">RasterLayer (<code>externalptr</code>; <em>not all</em>)</td>
</tr>
<tr class="even">
<td align="left"><strong>Rcpp</strong></td>
<td align="left">NativeSymbol (<code>externalptr</code>)</td>
</tr>
<tr class="odd">
<td align="left"><strong>reticulate</strong></td>
<td align="left">python.builtin.function (<code>externalptr</code>), python.builtin.module (<code>externalptr</code>)</td>
</tr>
<tr class="even">
<td align="left"><strong>rJava</strong></td>
<td align="left">jclassName (<code>externalptr</code>)</td>
</tr>
<tr class="odd">
<td align="left"><strong>rstan</strong></td>
<td align="left">stanmodel (<code>externalptr</code>)</td>
</tr>
<tr class="even">
<td align="left"><strong>ShortRead</strong></td>
<td align="left">FastqFile, FastqStreamer, FastqStreamerList (<code>connection</code>)</td>
</tr>
<tr class="odd">
<td align="left"><strong>sparklyr</strong></td>
<td align="left">tbl_spark (<code>externalptr</code>)</td>
</tr>
<tr class="even">
<td align="left"><strong>terra</strong></td>
<td align="left">SpatRaster, SpatVector (<code>externalptr</code>)</td>
</tr>
<tr class="odd">
<td align="left"><strong>udpipe</strong></td>
<td align="left">udpipe_model (<code>externalptr</code>)</td>
</tr>
<tr class="even">
<td align="left"><strong>xgboost</strong></td>
<td align="left">xgb.DMatrix (<code>externalptr</code>)</td>
</tr>
<tr class="odd">
<td align="left"><strong>xml2</strong></td>
<td align="left">xml_document (<code>externalptr</code>)</td>
</tr>
</tbody>
</table>
<p>These are illustrated in sections 'Packages that rely on external pointers' and 'Packages with other types of non-external objects' below.</p>
<div id="packages-with-connections" class="section level3">
<h3 class="hasAnchor">
<a href="#packages-with-connections" class="anchor"></a>Packages with connections</h3>
<div id="package-parallel" class="section level4">
<h4 class="hasAnchor">
<a href="#package-parallel" class="anchor"></a>Package: parallel</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>

<span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">makeCluster</a></span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">parSapply</span><span class="op">(</span><span class="va">cl</span>, X <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, FUN <span class="op">=</span> <span class="va">sqrt</span><span class="op">)</span>
<span class="va">y</span>
<span class="co">## [1] 1.414214 1.732051</span>

<span class="va">y</span> <span class="op">%&lt;-%</span> <span class="fu">parSapply</span><span class="op">(</span><span class="va">cl</span>, X <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, FUN <span class="op">=</span> <span class="va">sqrt</span><span class="op">)</span>
<span class="va">y</span>
<span class="co">## Error in summary.connection(connection) : invalid connection</span></code></pre></div>
<p>If we turn on <code><a href="https://docs.ropensci.org/magick/reference/options.html">options(future.globals.onReference = "error")</a></code>, we will catch this already when we create the future:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">y</span> <span class="op">%&lt;-%</span> <span class="fu">parSapply</span><span class="op">(</span><span class="va">cl</span>, X <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, FUN <span class="op">=</span> <span class="va">sqrt</span><span class="op">)</span>
<span class="co">## Error: Detected a non-exportable reference ('externalptr') in one of the globals</span>
<span class="co">## ('cl' of class 'SOCKcluster') used in the future expression</span></code></pre></div>
</div>
</div>
<div id="packages-that-rely-on-external-pointers" class="section level3">
<h3 class="hasAnchor">
<a href="#packages-that-rely-on-external-pointers" class="anchor"></a>Packages that rely on external pointers</h3>
<p>If an object carries an <em>external pointer</em>, it is likely that it can only be used in the R session where it was created. If it is exported to and used in a parallel process, it will likely cause an error there. As shown above, and in below examples, setting option <code>future.globals.onReference</code> to <code>"error"</code> will make <strong>future</strong> to scan for <em>external pointer</em>:s before launching the future on a parallel worker, and throw an error if one is detected.</p>
<p>However, there are objects with <em>external pointer</em>:s that can be exported, e.g. <code>data.table</code> objects of the <a href="https://cran.r-project.org/package=data.table">data.table</a> package is one such example. In other words, the existence of a <em>external pointer</em> is just a suggestion for an object being non-exportable - it is not a sufficient condition.</p>
<p>Below are some examples of packages who produce non-exportable objects with <em>external pointer</em>:s.</p>
<div id="package-dbi" class="section level4">
<h4 class="hasAnchor">
<a href="#package-dbi" class="anchor"></a>Package: DBI</h4>
<p><a href="https://cran.r-project.org/package=DBI">DBI</a> provides a unified database interface for communication between R and various database engines. Analogously to regular connections in R, DBIConnection objects can <em>not</em> safely be exported to another R process, e.g.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>future.globals.onReference <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span>
<span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org">DBI</a></span><span class="op">)</span>
<span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html">dbConnect</a></span><span class="op">(</span><span class="fu">RSQLite</span><span class="fu">::</span><span class="fu"><a href="https://rsqlite.r-dbi.org/reference/SQLite.html">SQLite</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">":memory:"</span><span class="op">)</span>
<span class="va">dummy</span> <span class="op">%&lt;-%</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span>
<span class="co">## Error: Detected a non-exportable reference ('externalptr') in one of the globals</span>
<span class="co">## ('con' of class 'SQLiteConnection') used in the future expression</span></code></pre></div>
</div>
<div id="package-keras" class="section level4">
<h4 class="hasAnchor">
<a href="#package-keras" class="anchor"></a>Package: keras</h4>
<p>The <a href="https://cran.r-project.org/package=DBI">keras</a> package provides an R interface to <a href="https://keras.io/">Keras</a>, which "is a high-level neural networks API developed with a focus on enabling fast experimentation". The R implementation accesses the Keras Python API via <a href="https://cran.r-project.org/package=reticulate">reticulate</a>. However, Keras model instances in R make use of R connections and external pointers, which prevents them from being exported to external R processes. For example, if the attempt to use a Keras model in a multisession workers, the worker will produce a run-time error:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(keras)

<span class="kw">library</span>(future)
<span class="kw">plan</span>(multisession)

model &lt;-<span class="st"> </span><span class="kw">keras_model_sequential</span>()
f &lt;-<span class="st"> </span><span class="kw">future</span>(model <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">       </span><span class="kw">layer_dense</span>(<span class="dt">units =</span> <span class="dv">256</span>, <span class="dt">activation =</span> <span class="st">'relu'</span>, <span class="dt">input_shape =</span> <span class="kw">c</span>(<span class="dv">784</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">       </span><span class="kw">layer_dropout</span>(<span class="dt">rate =</span> <span class="fl">0.4</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">       </span><span class="kw">layer_dense</span>(<span class="dt">units =</span> <span class="dv">128</span>, <span class="dt">activation =</span> <span class="st">'relu'</span>) <span class="op">%&gt;%</span>
<span class="st">       </span><span class="kw">layer_dropout</span>(<span class="dt">rate =</span> <span class="fl">0.3</span>) <span class="op">%&gt;%</span>
<span class="st">       </span><span class="kw">layer_dense</span>(<span class="dt">units =</span> <span class="dv">10</span>, <span class="dt">activation =</span> <span class="st">'softmax'</span>))
model2 &lt;-<span class="st"> </span><span class="kw">value</span>(f)
Error <span class="cf">in</span> object<span class="op">$</span><span class="kw">add</span>(layer) <span class="op">:</span><span class="st"> </span>attempt to apply non<span class="op">-</span><span class="cf">function</span></code></pre></div>
<p>If we turn on <code><a href="https://docs.ropensci.org/magick/reference/options.html">options(future.globals.onReference = "error")</a></code>, we will catch this already when we create the future:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Error<span class="op">:</span><span class="st"> </span>Detected a non<span class="op">-</span>exportable <span class="kw">reference</span> (<span class="st">'externalptr'</span>) <span class="cf">in</span> one of the
<span class="kw">globals</span> (<span class="st">'model'</span> of class <span class="st">'keras.engine.sequential.Sequential'</span>) used <span class="cf">in</span>
the future expression</code></pre></div>
</div>
<div id="package-magic" class="section level4">
<h4 class="hasAnchor">
<a href="#package-magic" class="anchor"></a>Package: magic</h4>
<p>The <a href="https://cran.r-project.org/package=magick">magick</a> package provides an R-level API for ImageMagick to work with images. When working with this API, the images are represented internally as external pointers of class 'magick_image' that cannot be be exported to another R process, e.g.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/magick/">magick</a></span><span class="op">)</span>
<span class="va">frink</span> <span class="op">&lt;-</span> <span class="fu">magick</span><span class="fu">::</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/editing.html">image_read</a></span><span class="op">(</span><span class="st">"https://jeroen.github.io/images/frink.png"</span><span class="op">)</span>
<span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/future.html">future</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/painting.html">image_fill</a></span><span class="op">(</span><span class="va">frink</span>, <span class="st">"orange"</span>, <span class="st">"+100+200"</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span>
<span class="va">v</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/value.html">value</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span>
<span class="co">## Error: Image pointer is dead. You cannot save or cache image objects</span>
<span class="co">## between R sessions.</span></code></pre></div>
<p>If we set:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://docs.ropensci.org/magick/reference/options.html">options</a></span><span class="op">(</span>future.globals.onReference <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span></code></pre></div>
<p>we'll see that this is caught even before attempting to run this in parallel;</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="op">&gt;</span><span class="st"> </span>f &lt;-<span class="st"> </span><span class="kw">future</span>(<span class="kw">image_fill</span>(frink, <span class="st">"orange"</span>, <span class="st">"+100+200"</span>, <span class="dv">20</span>))
## Error: Detected a non-exportable reference ('externalptr' of class
## 'magick-image') in one of the globals ('frink' of class 'magick-image')
## used in the future expression</code></pre></div>
</div>
<div id="package-raster" class="section level4">
<h4 class="hasAnchor">
<a href="#package-raster" class="anchor"></a>Package: raster</h4>
<p>The <a href="https://cran.r-project.org/package=raster">raster</a> package provides methods for working with spatial data, which are held in 'RasterLayer' objects. Not all but some of these objects use an external pointer. For example,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(future)
<span class="kw">plan</span>(multisession)

<span class="kw">library</span>(raster)
r &lt;-<span class="st"> </span><span class="kw">raster</span>(<span class="kw">system.file</span>(<span class="st">"external/test.grd"</span>, <span class="dt">package =</span> <span class="st">"raster"</span>))
tf &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="dt">fileext =</span> <span class="st">".grd"</span>)
s &lt;-<span class="st"> </span><span class="kw">writeStart</span>(r, <span class="dt">filename =</span> tf,  <span class="dt">overwrite =</span> <span class="ot">TRUE</span>)

f &lt;-<span class="st"> </span><span class="kw">future</span>({
  <span class="kw">print</span>(<span class="kw">dim</span>(r))
  <span class="kw">print</span>(<span class="kw">dim</span>(s))
})
Error<span class="op">:</span><span class="st"> </span>Detected a non<span class="op">-</span>exportable <span class="kw">reference</span> (<span class="st">'externalptr'</span>) <span class="cf">in</span> one of the
<span class="kw">globals</span> (<span class="st">'s'</span> of class <span class="st">'RasterLayer'</span>) used <span class="cf">in</span> the future expression</code></pre></div>
<p>Note that it is only the RasterLayer object <code>s</code> that carries an external pointer and cannot be passed on to an external worker. In contrast, RasterLayer object <code>r</code> does not have this problem and would be fine to pass on to a worker.</p>
</div>
<div id="package-rcpp" class="section level4">
<h4 class="hasAnchor">
<a href="#package-rcpp" class="anchor"></a>Package: Rcpp</h4>
<p>Another example is <a href="https://cran.r-project.org/package=Rcpp">Rcpp</a> , which allow us to easily create R functions that are implemented in C++, e.g.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">Rcpp</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Rcpp/man/sourceCpp.html">sourceCpp</a></span><span class="op">(</span>code <span class="op">=</span> <span class="st">"
using namespace Rcpp;

// [[Rcpp::export]]
int my_length(NumericVector x) {
    return x.size();
}
"</span><span class="op">)</span></code></pre></div>
<p>so that:</p>
<pre><code>x &lt;- 1:10
my_length(x)
## [1] 10</code></pre>
<p>However, since this function uses an external pointer internally, we cannot pass it to another R process:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>
<span class="va">n</span> <span class="op">%&lt;-%</span> <span class="fu">my_length</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="va">n</span>
<span class="co">## Error in .Call(&lt;pointer: (nil)&gt;, x) : NULL value passed as symbol address</span></code></pre></div>
<p>We can detect / protect against this using:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://docs.ropensci.org/magick/reference/options.html">options</a></span><span class="op">(</span>future.globals.onReference <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span>
<span class="va">n</span> <span class="op">%&lt;-%</span> <span class="fu">my_length</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="co">## Error: Detected a non-exportable reference ('externalptr' of class</span>
<span class="co">## 'NativeSymbol') in one of the globals ('my_length' of class 'function')</span>
<span class="co">## used in the future expression</span></code></pre></div>
</div>
<div id="package-reticulate" class="section level4">
<h4 class="hasAnchor">
<a href="#package-reticulate" class="anchor"></a>Package: reticulate</h4>
<p>The <a href="https://cran.r-project.org/package=reticulate">reticulate</a> package provides methods for creating and calling Python code from within R. If one attempt to use Python-binding objects from this package, we get errors like:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/reticulate">reticulate</a></span><span class="op">)</span>
<span class="va">os</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reticulate/man/import.html">import</a></span><span class="op">(</span><span class="st">"os"</span><span class="op">)</span>
<span class="va">pwd</span> <span class="op">%&lt;-%</span> <span class="va">os</span><span class="op">$</span><span class="fu">getcwd</span><span class="op">(</span><span class="op">)</span>
<span class="va">pwd</span>
<span class="co">## Error in eval(quote(os$getcwd()), new.env()) : </span>
<span class="co">##   attempt to apply non-function</span></code></pre></div>
<p>and by telling the future package to validate globals further, we get:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://docs.ropensci.org/magick/reference/options.html">options</a></span><span class="op">(</span>future.globals.onReference <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span>
<span class="va">pwd</span> <span class="op">%&lt;-%</span> <span class="va">os</span><span class="op">$</span><span class="fu">getcwd</span><span class="op">(</span><span class="op">)</span>
<span class="co">## Error: Detected a non-exportable reference ('externalptr') in one of the</span>
<span class="co">## globals ('os' of class 'python.builtin.module') used in the future expression</span></code></pre></div>
<p>Another reticulate example is when we try to use a Python function that we create ourselves as in:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"def twice(x):\n    return 2*x\n"</span>, file <span class="op">=</span> <span class="st">"twice.py"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/reticulate/man/source_python.html">source_python</a></span><span class="op">(</span><span class="st">"twice.py"</span><span class="op">)</span>
<span class="fu">twice</span><span class="op">(</span><span class="fl">1.2</span><span class="op">)</span>
<span class="co">## [1] 2.4</span>
<span class="va">y</span> <span class="op">%&lt;-%</span> <span class="fu">twice</span><span class="op">(</span><span class="fl">1.2</span><span class="op">)</span>
<span class="va">y</span>
<span class="co">## Error in unserialize(node$con) : </span>
<span class="co">##   Failed to retrieve the value of MultisessionFuture from cluster node #1</span>
<span class="co">##   (on 'localhost').  The reason reported was 'error reading from connection'</span></code></pre></div>
<p>which, again, is because:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://docs.ropensci.org/magick/reference/options.html">options</a></span><span class="op">(</span>future.globals.onReference <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span>
<span class="va">y</span> <span class="op">%&lt;-%</span> <span class="fu">twice</span><span class="op">(</span><span class="fl">1.2</span><span class="op">)</span>
<span class="co">## Error: Detected a non-exportable reference ('externalptr') in one of the globals</span>
<span class="co">## ('twice' of class 'python.builtin.function') used in the future expression</span></code></pre></div>
</div>
<div id="package-rjava" class="section level4">
<h4 class="hasAnchor">
<a href="#package-rjava" class="anchor"></a>Package: rJava</h4>
<p>Here is an example that shows how <a href="https://cran.r-project.org/package=rJava">rJava</a> objects cannot be exported to external R processes.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">rJava</span><span class="op">)</span>
<span class="fu">.jinit</span><span class="op">(</span><span class="op">)</span> <span class="co">## Initialize Java VM on master</span>

<span class="va">Double</span> <span class="op">&lt;-</span> <span class="fu">J</span><span class="op">(</span><span class="st">"java.lang.Double"</span><span class="op">)</span>
<span class="va">d0</span> <span class="op">&lt;-</span> <span class="fu">new</span><span class="op">(</span><span class="va">Double</span>, <span class="st">"3.14"</span><span class="op">)</span>
<span class="va">d0</span>
<span class="co">## [1] "Java-Object{3.14}"</span>

<span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/future.html">future</a></span><span class="op">(</span><span class="op">{</span>
  <span class="fu">.jinit</span><span class="op">(</span><span class="op">)</span> <span class="co">## Initialize Java VM on worker</span>
  <span class="fu">new</span><span class="op">(</span><span class="va">Double</span>, <span class="st">"3.14"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="va">d1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/value.html">value</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span>
<span class="va">d1</span>
<span class="co">## [1] "Java-Object&lt;null&gt;"</span></code></pre></div>
<p>Although no error is produced, we see that the value <code>d1</code> is a Java NULL Object. As before, we can catch this by using:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://docs.ropensci.org/magick/reference/options.html">options</a></span><span class="op">(</span>future.globals.onReference <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span>
<span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/future.html">future</a></span><span class="op">(</span><span class="op">{</span>
  <span class="fu">.jinit</span><span class="op">(</span><span class="op">)</span> <span class="co">## Initialize Java VM on worker</span>
  <span class="fu">new</span><span class="op">(</span><span class="va">Double</span>, <span class="st">"3.14"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">## Error: Detected a non-exportable reference ('externalptr') in one of the</span>
<span class="co">## globals ('Double' of class 'jclassName') used in the future expression</span></code></pre></div>
</div>
<div id="package-shortread" class="section level4">
<h4 class="hasAnchor">
<a href="#package-shortread" class="anchor"></a>Package: ShortRead</h4>
<p>The <strong><a href="https://bioconductor.org/packages/ShortRead/">ShortRead</a></strong> package from Bioconductor implements efficient methods for sampling, iterating, and reading FASTQ files. Some of the helper objects used cannot be saved to file or exported to a parallel worker, because they comprise of connections and other non-exportable objects.</p>
<p>Here is an example that illustrates how an attempt to use a 'FastqStreamer' object created in the main R session fails when used in a parallel worker:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">ShortRead</span><span class="op">)</span>
<span class="va">sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ShortRead/man/SolexaPath-class.html">SolexaPath</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package<span class="op">=</span><span class="st">"ShortRead"</span><span class="op">)</span><span class="op">)</span>
<span class="va">fl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/ShortRead/man/accessors.html">analysisPath</a></span><span class="op">(</span><span class="va">sp</span><span class="op">)</span>, <span class="st">"s_1_sequence.txt"</span><span class="op">)</span>
<span class="va">fs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ShortRead/man/Sampler-class.html">FastqStreamer</a></span><span class="op">(</span><span class="va">fl</span>, <span class="fl">50</span><span class="op">)</span>

<span class="va">reads</span> <span class="op">%&lt;-%</span> <span class="fu"><a href="https://rdrr.io/pkg/ShortRead/man/Sampler-class.html">yield</a></span><span class="op">(</span><span class="va">fs</span><span class="op">)</span>
<span class="va">reads</span>
<span class="co">## Error in status(update = TRUE) : invalid FastqStreamer</span></code></pre></div>
<p>To catch this earlier, and to get a more informative error message, we do as before;</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://docs.ropensci.org/magick/reference/options.html">options</a></span><span class="op">(</span>future.globals.onReference <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span>

<span class="va">reads</span> <span class="op">%&lt;-%</span> <span class="fu"><a href="https://rdrr.io/pkg/ShortRead/man/Sampler-class.html">yield</a></span><span class="op">(</span><span class="va">fs</span><span class="op">)</span>
<span class="co">## Error: Detected a non-exportable reference ('externalptr') in one of the</span>
<span class="co">## globals ('fs' of class 'FastqStreamer') used in the future expression</span></code></pre></div>
</div>
<div id="package-sparklyr" class="section level4">
<h4 class="hasAnchor">
<a href="#package-sparklyr" class="anchor"></a>Package: sparklyr</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">sparklyr</span><span class="op">)</span>
<span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu">spark_connect</span><span class="op">(</span>master <span class="op">=</span> <span class="st">"local"</span><span class="op">)</span>

<span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"misc"</span>, <span class="st">"exDIF.csv"</span>, package <span class="op">=</span> <span class="st">"utils"</span><span class="op">)</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">spark_read_csv</span><span class="op">(</span><span class="va">sc</span>, <span class="st">"exDIF"</span>, <span class="va">file</span><span class="op">)</span>
<span class="va">d</span> <span class="op">%&lt;-%</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
<span class="va">d</span>
<span class="co">## Error in unserialize(node$con) : </span>
<span class="co">##   Failed to retrieve the value of MultisessionFuture (&lt;none&gt;) from cluster</span>
<span class="co">## SOCKnode #1 (PID 29864 on localhost 'localhost'). The reason reported was</span>
<span class="co">## 'unknown input format'. Post-mortem diagnostic: A process with this PID</span>
<span class="co">## exists, which suggests that the localhost worker is still alive.</span></code></pre></div>
<p>To catch this as soon as possible,</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://docs.ropensci.org/magick/reference/options.html">options</a></span><span class="op">(</span>future.globals.onReference <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span>
<span class="va">d</span> <span class="op">%&lt;-%</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
<span class="co">## Error: Detected a non-exportable reference ('externalptr') in one of</span>
<span class="co">## the globals ('data' of class 'tbl_spark') used in the future expression</span></code></pre></div>
</div>
<div id="package-terra" class="section level4">
<h4 class="hasAnchor">
<a href="#package-terra" class="anchor"></a>Package: terra</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(future)
<span class="kw">plan</span>(multisession)
<span class="kw">library</span>(terra)

file &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"ex/lux.shp"</span>, <span class="dt">package =</span> <span class="st">"terra"</span>)
v &lt;-<span class="st"> </span><span class="kw">vect</span>(file)
dv <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">dim</span>(v)
dv
Error <span class="cf">in</span> x<span class="op">@</span>ptr<span class="op">$</span><span class="kw">nrow</span>() <span class="op">:</span><span class="st"> </span>external pointer is not valid

file &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"ex/elev.tif"</span>, <span class="dt">package=</span><span class="st">"terra"</span>)
r &lt;-<span class="st"> </span><span class="kw">rast</span>(file)
dr <span class="op">%&lt;-%</span><span class="st"> </span><span class="kw">dim</span>(r)
dr
## Error in .External(list(name = "CppMethod__invoke_notvoid", address = &lt;pointer: (nil)&gt;,  : 
##  NULL value passed as symbol address</code></pre></div>
<p>To catch this as soon as possible,</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://docs.ropensci.org/magick/reference/options.html">options</a></span><span class="op">(</span>future.globals.onReference <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span>

<span class="va">dv</span> <span class="op">%&lt;-%</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>
<span class="co">## Error: Detected a non-exportable reference ('externalptr' of class</span>
<span class="co">## 'RegisteredNativeSymbol') in one of the globals ('v' of class</span>
<span class="co">## 'SpatVector') used in the future expression</span>

<span class="va">dr</span> <span class="op">%&lt;-%</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>
<span class="co">## Error: Detected a non-exportable reference ('externalptr' of class</span>
<span class="co">## 'RegisteredNativeSymbol') in one of the globals ('r' of class</span>
<span class="co">## 'SpatRaster') used in the future expression</span></code></pre></div>
<p>For some workarounds, see <code><a href="https://rdrr.io/pkg/terra/man/wrap.html">help("wrap", package = "terra")</a></code>.</p>
</div>
<div id="package-udpipe" class="section level4">
<h4 class="hasAnchor">
<a href="#package-udpipe" class="anchor"></a>Package: udpipe</h4>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">udpipe</span><span class="op">)</span>
<span class="va">udmodel</span> <span class="op">&lt;-</span> <span class="fu">udpipe_download_model</span><span class="op">(</span>language <span class="op">=</span> <span class="st">"dutch"</span><span class="op">)</span>
<span class="va">udmodel</span> <span class="op">&lt;-</span> <span class="fu">udpipe_load_model</span><span class="op">(</span>file <span class="op">=</span> <span class="va">udmodel</span><span class="op">$</span><span class="va">file_model</span><span class="op">)</span>
<span class="va">x</span> <span class="op">%&lt;-%</span> <span class="fu">udpipe_annotate</span><span class="op">(</span><span class="va">udmodel</span>, x <span class="op">=</span> <span class="st">"Ik ging op reis en ik nam mee."</span><span class="op">)</span>
<span class="va">x</span>
<span class="co">## Error in udp_tokenise_tag_parse(object$model, x, doc_id, tokenizer, tagger,  : </span>
<span class="co">##   external pointer is not valid</span></code></pre></div>
<p>To catch this as soon as possible,</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://docs.ropensci.org/magick/reference/options.html">options</a></span><span class="op">(</span>future.globals.onReference <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span>
<span class="va">x</span> <span class="op">%&lt;-%</span> <span class="fu">udpipe_annotate</span><span class="op">(</span><span class="va">udmodel</span>, x <span class="op">=</span> <span class="st">"Ik ging op reis en ik nam mee."</span><span class="op">)</span>
<span class="co">## Error: Detected a non-exportable reference ('externalptr') in one of the</span>
<span class="co">## globals ('udmodel' of class 'udpipe_model') used in the future expression</span></code></pre></div>
<p>Now, it is indeed possible to parallelize ` calls. For details on how to do this, see the 'UDPipe Natural Language Processing - Parallel' vignette that comes with the  package.</p>
</div>
<div id="package-xgboost" class="section level4">
<h4 class="hasAnchor">
<a href="#package-xgboost" class="anchor"></a>Package: xgboost</h4>
<p>The <a href="https://cran.r-project.org/package=xgboost">xgboost</a> package provides fast gradient-boosting methods. Some of its data structures use external pointers. For example,</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmlc/xgboost">xgboost</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">agaricus.train</span>, package <span class="op">=</span> <span class="st">"xgboost"</span><span class="op">)</span>
<span class="va">train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xgboost/man/xgb.DMatrix.html">xgb.DMatrix</a></span><span class="op">(</span><span class="va">agaricus.train</span><span class="op">$</span><span class="va">data</span>, label <span class="op">=</span> <span class="va">agaricus.train</span><span class="op">$</span><span class="va">label</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">train</span><span class="op">)</span>
<span class="co">## [1] "xgb.DMatrix"</span>

<span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">dtrain</span><span class="op">)</span>
<span class="va">d</span>
<span class="co">## [1] 6513  126</span></code></pre></div>
<p>works just fine but if we attempt to pass on the 'xgb.DMatrix' object <code>train</code> to an external worker, we silently get a incorrect value:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/future.html">future</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">dtrain</span><span class="op">)</span><span class="op">)</span>
<span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/value.html">value</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span>
<span class="va">d</span>
<span class="co">## NULL</span></code></pre></div>
<p>This is unfortunate, but we can at least detect this by:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://docs.ropensci.org/magick/reference/options.html">options</a></span><span class="op">(</span>future.globals.onReference <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span>
<span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/future.html">future</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">dtrain</span><span class="op">)</span><span class="op">)</span>
<span class="co">## Error: Detected a non-exportable reference ('externalptr' of class 'xgb.DMatrix')</span>
<span class="co">## in one of the globals ('dtrain' of class 'xgb.DMatrix') used in the future expression</span></code></pre></div>
</div>
<div id="package-xml2" class="section level4">
<h4 class="hasAnchor">
<a href="#package-xml2" class="anchor"></a>Package: xml2</h4>
<p>Another example is XML objects of the <a href="https://cran.r-project.org/package=xml2">xml2</a> package, which may produce evaluation errors (or just invalid results depending on how they are used), e.g.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://xml2.r-lib.org/">xml2</a></span><span class="op">)</span>
<span class="va">xml</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_xml</a></span><span class="op">(</span><span class="st">"&lt;body&gt;&lt;/body&gt;"</span><span class="op">)</span>
<span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/future.html">future</a></span><span class="op">(</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_children</a></span><span class="op">(</span><span class="va">xml</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="../reference/value.html">value</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span>
<span class="co">## Error: external pointer is not valid</span></code></pre></div>
<p>The future framework can help detect this <em>before</em> sending off the future to the worker;</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://docs.ropensci.org/magick/reference/options.html">options</a></span><span class="op">(</span>future.globals.onReference <span class="op">=</span> <span class="st">"error"</span><span class="op">)</span>
<span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/future.html">future</a></span><span class="op">(</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_children.html">xml_children</a></span><span class="op">(</span><span class="va">xml</span><span class="op">)</span><span class="op">)</span>
<span class="co">## Error: Detected a non-exportable reference ('externalptr') in one of the</span>
<span class="co">## globals ('xml' of class 'xml_document') used in the future expression</span></code></pre></div>
</div>
</div>
<div id="packages-with-other-types-of-non-external-objects" class="section level3">
<h3 class="hasAnchor">
<a href="#packages-with-other-types-of-non-external-objects" class="anchor"></a>Packages with other types of non-external objects</h3>
<div id="package-ncdf4" class="section level4">
<h4 class="hasAnchor">
<a href="#package-ncdf4" class="anchor"></a>Package: ncdf4</h4>
<p>Package <a href="https://cran.r-project.org/package=ncdf4">ncdf4</a> provides an R API to work with data that live in netCDF files. For example, we can create a simple netCDF file that holds a variable 'x':</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">ncdf4</span><span class="op">)</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">ncvar_def</span><span class="op">(</span><span class="st">"x"</span>, units<span class="op">=</span><span class="st">"count"</span>, dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">file</span> <span class="op">&lt;-</span> <span class="fu">nc_create</span><span class="op">(</span><span class="st">"example.nc"</span>, <span class="va">x</span><span class="op">)</span>
<span class="fu">ncvar_put</span><span class="op">(</span><span class="va">file</span>, <span class="va">x</span>, <span class="fl">42</span><span class="op">)</span>
<span class="fu">nc_close</span><span class="op">(</span><span class="va">file</span><span class="op">)</span></code></pre></div>
<p>We can now use this netCDF file next time we start R, e.g.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">ncdf4</span><span class="op">)</span>
<span class="va">file</span> <span class="op">&lt;-</span> <span class="fu">nc_open</span><span class="op">(</span><span class="st">"example.nc"</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">ncvar_get</span><span class="op">(</span><span class="va">file</span><span class="op">)</span>
<span class="va">y</span>
<span class="co">## [1] 42</span></code></pre></div>
<p>However, it would fail if we attempt to use <code>ncdf</code>, which is an object of class 'ncdf4', in a parallel worker, we will get an error:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">ncdf4</span><span class="op">)</span>
<span class="va">file</span> <span class="op">&lt;-</span> <span class="fu">nc_open</span><span class="op">(</span><span class="st">"example.nc"</span><span class="op">)</span>
<span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/future.html">future</a></span><span class="op">(</span><span class="fu">ncvar_get</span><span class="op">(</span><span class="va">file</span><span class="op">)</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/value.html">value</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span>
<span class="co">## Error in R_nc4_inq_varndims: NetCDF: Not a valid ID</span>
<span class="co">## Error in ncvar_ndims(ncid, varid) : error returned from C call</span></code></pre></div>
<p>This is because ncdf4 objects make use of internal references that are unique to the R session where they were created. However, these are <em>not</em> formal <em>external pointer</em>:s, meaning the future framework cannot detect them. That is, using <code><a href="https://docs.ropensci.org/magick/reference/options.html">options(future.globals.onReference = "error")</a></code> is of no help here.</p>
<p>A workaround is to open the netCDF in each worker, e.g.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">ncdf4</span><span class="op">)</span>
<span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/future.html">future</a></span><span class="op">(</span><span class="op">{</span>
  <span class="va">file</span> <span class="op">&lt;-</span> <span class="fu">nc_open</span><span class="op">(</span><span class="st">"example.nc"</span><span class="op">)</span>
  <span class="va">value</span> <span class="op">&lt;-</span> <span class="fu">ncvar_get</span><span class="op">(</span><span class="va">file</span><span class="op">)</span>
  <span class="fu">nc_close</span><span class="op">(</span><span class="va">file</span><span class="op">)</span>
  <span class="va">value</span>
<span class="op">}</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/value.html">value</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span>
<span class="va">y</span>
<span class="co">## [1] 42</span></code></pre></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Henrik Bengtsson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1 and <a href="https://github.com/HenrikBengtsson/pkgdown.extras/">pkgdown.extras</a> 0.0.0.9002.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: 'aa6e02fc501886fb0f7c91ac4e300456',
    indexName: 'futureverse',
    algoliaOptions: { 'facetFilters': ['project:future'] },
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
